{% extends 'base.html' %}
{% load static %}

{% block title %}{{ service.title }} - ConstructPro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/service-detail-variants.css' %}">
<style>
    /* Override or fixes for production */
    .layout-wrapper {
        padding-top: 0;
        padding-bottom: 0;
        border: none;
    }

    .ls-hero {
        padding: 66px 0 20px !important;
        text-align: left;
    }

    /* Adjust for navbar */
    .ls-sidebar {
        top: 120px;
    }

    /* Back to Services Link */
    .back-to-services-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 30px;
        margin-bottom: 20px;
        padding: 0;
        background: transparent;
        border: none;
        color: white;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        opacity: 0.9;
    }

    .back-to-services-link:hover {
        opacity: 1;
        transform: translateX(-5px);
    }

    .back-to-services-link i {
        font-size: 0.9rem;
        transition: transform 0.3s ease;
    }

    .back-to-services-link:hover i {
        transform: translateX(-3px);
    }

    .subsection-title {
        font-size: 1.05rem !important;
        color: #2c3e50;
        margin-top: 1.25rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
        border-bottom: none !important;
        padding-bottom: 0 !important;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Integrated Smart Pill Layout */
    .service-glass-highlight-section {
        margin-top: 2.5rem;
        padding: 0;
    }

    .service-glass-highlight-section h2 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        font-weight: 700;
        text-align: left;
        font-size: 1.4rem;
        position: relative;
        text-transform: none;
        letter-spacing: normal;
    }

    .service-glass-highlight-section h2::after {
        content: none;
        display: none;
    }

    .glass-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
    }

    .glass-card {
        background: #e0e7ec;
        /* background: #fff; */
        padding: 0.6rem 1rem;
        border-radius: 50px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        display: flex;
        flex-direction: row;
        align-items: center;
        text-align: left;
        gap: 12px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
        animation: popIn 0.4s ease backwards;
        height: auto;
        /* Allow height to grow */
        min-height: 50px;
    }

    .glass-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.05);
        border-color: #2c5f7c;
    }

    .glass-icon-wrapper {
        position: relative;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .glass-icon-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #f1f5f9;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .glass-card:hover .glass-icon-bg {
        background: #e3f2fd;
        transform: scale(1.1);
    }

    .glass-icon-main {
        font-size: 0.9rem;
        color: #64748b;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .glass-card:hover .glass-icon-main {
        color: #2c5f7c;
        animation: wobble 1s ease-in-out infinite;
    }

    .glass-text {
        font-weight: 500;
        color: #334155;
        font-size: 0.9rem;
        z-index: 2;
        transition: color 0.3s ease;
        flex-grow: 1;
        line-height: 1.3;
        /* Better readability for multi-line */
    }

    .glass-card:hover .glass-text {
        color: #0f172a;
    }

    .glass-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(44, 95, 124, 0.1) 50%, rgba(255, 255, 255, 0) 100%);
        transform: skewX(-25deg);
        z-index: 1;
        pointer-events: none;
    }

    .glass-card:hover .glass-shine {
        left: 200%;
        transition: left 0.75s ease-in-out;
    }

    @keyframes popIn {
        0% {
            opacity: 0;
            transform: scale(0.9) translateY(10px);
        }

        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    @keyframes wobble {

        0%,
        100% {
            transform: rotate(0deg);
        }

        15% {
            transform: rotate(-5deg);
        }

        30% {
            transform: rotate(3deg);
        }

        45% {
            transform: rotate(-3deg);
        }

        60% {
            transform: rotate(2deg);
        }

        75% {
            transform: rotate(-1deg);
        }
    }

    /* Carousel Styles */
    .carousel-container {
        position: relative;
        width: 100%;
        margin-top: 2rem;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .carousel-track-wrapper {
        overflow: hidden;
        width: 100%;
        border-radius: 8px;
    }

    .carousel-track {
        display: flex;
        gap: 20px;
        transition: transform 0.5s ease-in-out;
        padding: 10px 5px;
    }

    .gallery-item-slide {
        flex: 0 0 calc(33.333% - 14px);
        aspect-ratio: 4/3;
        position: relative;
        cursor: pointer;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .gallery-item-slide:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }

    .gallery-item-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .gallery-item-slide:hover img {
        transform: scale(1.1);
    }

    .gallery-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item-slide:hover .gallery-overlay {
        opacity: 1;
    }

    .gallery-overlay i {
        color: white;
        font-size: 1.5rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }

    .carousel-nav {
        background: #fff;
        border: 1px solid #e2e8f0;
        color: #2c5f7c;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        z-index: 2;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
    }

    .carousel-nav.prev {
        left: -20px;
    }

    .carousel-nav.next {
        right: -20px;
    }

    .carousel-nav:hover {
        background: #2c5f7c;
        color: #fff;
        border-color: #2c5f7c;
        transform: translateY(-50%) scale(1.1);
    }

    @media (max-width: 992px) {
        .gallery-item-slide {
            flex: 0 0 calc(50% - 10px);
        }
    }

    @media (max-width: 600px) {
        .gallery-item-slide {
            flex: 0 0 100%;
        }
    }

    /* Lightbox Styles */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.95);
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .lightbox-content {
        position: relative;
        margin: auto;
        padding: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #lightbox-img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 4px;
        transition: transform 0.1s ease-out;
        cursor: grab;
        user-select: none;
    }

    #lightbox-img.grabbing {
        cursor: grabbing;
        transition: none;
    }

    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
        z-index: 2001;
    }

    .lightbox-close:hover {
        color: #bbb;
        text-decoration: none;
    }

    .lightbox-prev,
    .lightbox-next {
        cursor: pointer;
        position: absolute;
        top: 50%;
        width: auto;
        padding: 16px;
        margin-top: -50px;
        color: white;
        font-weight: bold;
        font-size: 30px;
        transition: 0.6s ease;
        border-radius: 0 3px 3px 0;
        user-select: none;
        background: rgba(0, 0, 0, 0.2);
        z-index: 2002;
    }

    .lightbox-next {
        right: 0;
        border-radius: 3px 0 0 3px;
    }

    .lightbox-prev {
        left: 0;
        border-radius: 3px 0 0 3px;
    }

    .lightbox-prev:hover,
    .lightbox-next:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }

    .lightbox-controls {
        position: absolute;
        bottom: 20px;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px 20px;
        border-radius: 30px;
        z-index: 2002;
    }

    .lightbox-controls button {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
        padding: 5px 15px;
        cursor: pointer;
        border-radius: 4px;
        margin: 0 5px;
        font-size: 1rem;
    }

    .lightbox-controls button:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: white;
    }
</style>
{% endblock %}

{% block content %}
<section class="layout-wrapper layout-sidebar">
    <div class="ls-hero"
        style="{% if service.image %}background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{{ service.image.url }}'); background-size: cover; background-position: center; color: white;{% endif %}">
        <div class="container">
            <a href="{% url 'home' %}#services" class="back-to-services-link">
                <i class="fa-solid fa-arrow-left"></i>
                Back to Services
            </a>
            <h1 style="{% if service.image %}color: white;{% endif %}">{{ service.title }}</h1>
            <p class="ls-lead" style="{% if service.image %}color: #eee;{% endif %}">{{ service.subtitle }}</p>
        </div>
    </div>

    <div class="container ls-container">
        <!-- Main Content -->
        <div class="ls-main">
            <!-- Main Overview (Start of First Block) -->
            <div class="ls-block">
                <h2>Overview</h2>
                <p>{{ service.overview }}</p>

                <!-- Dynamic Sections Loop -->
                {% for section in service.sections.all %}

                <!-- TEXT Section -->
                {% if section.section_type == 'text' %}
                {% if section.heading %}
                {% if section.is_subsection %}
                <h4 class="subsection-title">{{ section.heading }}</h4>
                {% else %}
                <h2>{{ section.heading }}</h2>
                {% endif %}
                {% endif %}
                <p>{{ section.content }}</p>

                <!-- TAGS Section -->
                {% elif section.section_type == 'tags' %}
                {% if section.heading %}<h4 class="subsection-title">{{ section.heading }}</h4>{% endif %}
                <div class="ls-tags">
                    {% for item in section.get_items_list %}
                    <span class="ls-tag">{{ item }}</span>
                    {% endfor %}
                </div>

                <!-- BENEFITS Section (Checkmarks) -->
                {% elif section.section_type == 'benefits' %}
                {% if section.heading %}
                {% if section.is_subsection %}
                <h4 class="subsection-title">{{ section.heading }}</h4>
                {% else %}
                <h2>{{ section.heading }}</h2>
                {% endif %}
                {% endif %}
                <ul style="list-style: none; padding: 0; margin-top: 1rem;">
                    {% for item in section.get_items_list %}
                    <li style="margin-bottom: 10px; display: flex; gap: 10px; align-items: start;">
                        <span style="color: #2c5f7c; font-weight: bold; min-width: 20px;">âœ“</span>
                        <span>{{ item }}</span>
                    </li>
                    {% endfor %}
                </ul>

                <!-- PROCESS Section (Numbered Steps) -->
                {% elif section.section_type == 'process' %}
                {% if section.heading %}
                {% if section.is_subsection %}
                <h4 class="subsection-title">{{ section.heading }}</h4>
                {% else %}
                <h2>{{ section.heading }}</h2>
                {% endif %}
                {% endif %}
                <div class="ls-steps" style="margin-top: 1.5rem;">
                    {% for item in section.get_items_list %}
                    <div class="ls-step" style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <span class="ls-step-num"
                            style="background: #2c5f7c; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                            {{ forloop.counter }}</span>
                        <p style="margin: 0; padding-top: 4px;">{{ item }}</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- LIST Section (Standard Bullets) -->
                {% elif section.section_type == 'list' %}
                {% if section.heading %}
                {% if section.is_subsection %}
                <h4 class="subsection-title">{{ section.heading }}</h4>
                {% else %}
                <h2>{{ section.heading }}</h2>
                {% endif %}
                {% endif %}
                <ul>
                    {% for item in section.get_items_list %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>

                {% endif %}
                {% endfor %}
            </div>

            <!-- Features Section (Smart Pills) -->
            {% if service.features.count > 0 %}
            <div class="ls-block service-glass-highlight-section">
                <h2>Services Include</h2>
                <div class="glass-grid">
                    {% for feature in service.features.all %}
                    <div class="glass-card" style="animation-delay: {{ forloop.counter|add:1|default:1 }}00ms">
                        <div class="glass-icon-wrapper">
                            <i class="{{ feature.icon }} glass-icon-main"></i>
                            <div class="glass-icon-bg"></div>
                        </div>
                        <span class="glass-text">{{ feature.title }}</span>
                        <div class="glass-shine"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Photo Gallery Section (Carousel) -->
            {% if service.images.count > 0 %}
            <div class="ls-block gallery-section">
                <h2>Services Photos</h2>
                <div class="carousel-container">
                    <button class="carousel-nav prev" onclick="scrollGallery(-1)">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>

                    <div class="carousel-track-wrapper">
                        <div class="carousel-track" id="galleryTrack">
                            {% for img in service.images.all %}
                            <div class="gallery-item-slide" onclick="openLightbox('{{ forloop.counter0 }}')">
                                <img src="{{ img.image.url }}" alt="{{ img.caption|default:service.title }}">
                                <div class="gallery-overlay"><i class="fa-solid fa-magnifying-glass-plus"></i></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <button class="carousel-nav next" onclick="scrollGallery(1)">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <div class="lightbox-content">
                <img id="lightbox-img" src="" alt="Gallery Image">
                <div class="lightbox-caption" id="lightbox-caption"></div>

                <a class="lightbox-prev" onclick="changeSlide(-1)">&#10094;</a>
                <a class="lightbox-next" onclick="changeSlide(1)">&#10095;</a>

                <!-- Zoom Controls -->
                <div class="lightbox-controls">
                    <button onclick="zoomImage(0.2)">+</button>
                    <button onclick="zoomImage(-0.2)">-</button>
                    <button onclick="resetZoom()">Reset</button>
                </div>
            </div>
        </div>

        <script>
            let currentImageIndex = 0;
            let currentZoom = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX, startY;
            let images = [];

            // Initialize images array on load
            document.addEventListener("DOMContentLoaded", function () {
                // Populate images array from Django template
                {% if service.images.count > 0 %}
                images = [
                    {% for img in service.images.all %}
                    {
                    src: "{{ img.image.url }}",
                    caption: "{{ img.caption|default:service.title }}"
                },
                {% endfor %}
                ];
            {% endif %}

            // Initialize Carousel
            const track = document.getElementById('galleryTrack');
            const carouselContainer = document.querySelector('.carousel-container');
            let autoPlayInterval;

            if (track && carouselContainer) {
                window.scrollGallery = function (direction) {
                    const itemWidth = track.firstElementChild.offsetWidth + 20; // Width + gap
                    const maxScroll = track.scrollWidth - track.parentElement.offsetWidth;

                    // Current Translate Position
                    const currentTransform = new WebKitCSSMatrix(window.getComputedStyle(track).transform);
                    let currentX = currentTransform.m41;

                    let newX = currentX - (direction * itemWidth);

                    // Boundary Check / Loop
                    // Simple loop: if scrolling right (dir=1) and at end, go to start
                    // If scrolling left (dir=-1) and at start, go to end

                    // Note: translateX is negative. 
                    // Start = 0. End = -maxScroll.

                    if (direction === 1 && Math.abs(currentX) >= maxScroll - 10) {
                        newX = 0; // Reset to start
                    } else if (direction === -1 && currentX >= 0) {
                        newX = -maxScroll; // Go to end
                    }

                    track.style.transform = `translateX(${newX}px)`;
                };

                function startAutoPlay() {
                    stopAutoPlay();
                    autoPlayInterval = setInterval(() => {
                        if (window.scrollGallery) window.scrollGallery(1);
                    }, 3000);
                }

                function stopAutoPlay() {
                    if (autoPlayInterval) clearInterval(autoPlayInterval);
                }

                startAutoPlay();
                carouselContainer.addEventListener('mouseenter', stopAutoPlay);
                carouselContainer.addEventListener('mouseleave', startAutoPlay);
            }

            // Attach events to lightbox image
            const img = document.getElementById('lightbox-img');
            if (img) {
                img.addEventListener('mousedown', startDrag);
                img.addEventListener('mousemove', drag);
                img.addEventListener('mouseup', endDrag);
                img.addEventListener('mouseleave', endDrag);
                img.addEventListener('wheel', handleWheel);

                // Touch support
                img.addEventListener('touchstart', touchStart);
                img.addEventListener('touchmove', touchMove);
                img.addEventListener('touchend', endDrag);
            }
            });

            function openLightbox(index) {
                currentImageIndex = parseInt(index);
                showLightbox();
                updateLightboxImage();
                resetZoom();
            }

            function closeLightbox() {
                document.getElementById('lightbox').style.display = "none";
                resetZoom();
            }

            function showLightbox() {
                document.getElementById('lightbox').style.display = "flex";
            }

            function changeSlide(n) {
                currentImageIndex += n;
                if (currentImageIndex >= images.length) {
                    currentImageIndex = 0;
                }
                if (currentImageIndex < 0) {
                    currentImageIndex = images.length - 1;
                }
                updateLightboxImage();
                resetZoom();
            }

            function updateLightboxImage() {
                if (images.length > 0) {
                    const img = document.getElementById('lightbox-img');
                    img.src = images[currentImageIndex].src;
                    const caption = document.getElementById('lightbox-caption');
                    if (caption) caption.innerText = images[currentImageIndex].caption;
                }
            }

            function updateTransform() {
                const img = document.getElementById('lightbox-img');
                img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
            }

            function zoomImage(delta) {
                const newZoom = currentZoom + delta;
                if (newZoom >= 0.1 && newZoom <= 10) { // Limit zoom range
                    currentZoom = newZoom;
                    updateTransform();
                }
            }

            function resetZoom() {
                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            }

            // Drag Functionality
            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                document.getElementById('lightbox-img').classList.add('grabbing');
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }

            function endDrag() {
                isDragging = false;
                const img = document.getElementById('lightbox-img');
                if (img) img.classList.remove('grabbing');
            }

            // Touch handlers
            function touchStart(e) {
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                }
            }
            function touchMove(e) {
                if (!isDragging) return;
                if (e.touches.length === 1) {
                    e.preventDefault(); // Prevent scrolling
                    translateX = e.touches[0].clientX - startX;
                    startY = e.touches[0].clientY - translateY;
                    updateTransform();
                }
            }

            // Wheel Zoom
            function handleWheel(e) {
                e.preventDefault();
                const delta = Math.sign(e.deltaY) * -0.2;
                zoomImage(delta);
            }

            // Close on outside click (if not dragging)
            window.onclick = function (event) {
                const modal = document.getElementById('lightbox');
                const content = document.querySelector('.lightbox-content');
                // Only close if clicking the dark overlay, not the content area
                if (event.target == modal || event.target == content) {
                    closeLightbox();
                }
            }

            // Keyboard nav
            document.addEventListener('keydown', function (event) {
                if (document.getElementById('lightbox').style.display === "flex") {
                    if (event.key === "Escape") closeLightbox();
                    if (event.key === "ArrowLeft") changeSlide(-1);
                    if (event.key === "ArrowRight") changeSlide(1);
                    if (event.key === "+" || event.key === "=") zoomImage(0.2);
                    if (event.key === "-") zoomImage(-0.2);
                    if (event.key === "0") resetZoom();
                }
            });
        </script>

        <!-- Sidebar -->
        <aside class="ls-sidebar">
            <div class="ls-widget ls-widget-primary">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round"
                        style="vertical-align: text-bottom; margin-right: 8px;">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>All Services
                </h3>
                <ul>
                    {% for s in services %}
                    <li>
                        <a href="{% url 'service_detail' s.slug %}"
                            style="text-decoration: none; color: {% if s.id == service.id %}#2c5f7c{% else %}inherit{% endif %}; font-weight: {% if s.id == service.id %}bold{% else %}normal{% endif %}; display: flex; align-items: center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right: 8px; flex-shrink: 0;">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                            {{ s.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="ls-cta-box">
                <h4>Ready to start?</h4>
                <p style="font-size: 0.9rem; margin-bottom: 15px; color: #666;">Contact us today to discuss your
                    project.</p>
                <a href="{% url 'contact' %}" class="btn-sidebar">Get a Free Quote</a>
            </div>
        </aside>
    </div>
</section>
{% endblock %}