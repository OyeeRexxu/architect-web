{% extends 'base.html' %}
{% load static %}

{% block title %}{{ service.title }} - ConstructPro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/service-detail-variants.css' %}">
<style>
    /* Override or fixes for production */
    .layout-wrapper {
        padding-top: 0;
        border: none;
    }

    .ls-hero {
        padding-top: 120px;
    }

    /* Adjust for navbar */
    .ls-sidebar {
        top: 120px;
    }
</style>
{% endblock %}

{% block content %}
<section class="layout-wrapper layout-sidebar">
    <div class="ls-hero"
        style="{% if service.image %}background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('{% static 'images/' %}{{ service.image }}'); background-size: cover; background-position: center; color: white;{% endif %}">
        <div class="container">
            <a href="{% url 'home' %}#services"
                style="display:inline-block; margin-bottom: 20px; color: {% if service.image %}#ddd{% else %}#666{% endif %}; text-decoration: none;">←
                Back to Services</a>
            <h1 style="{% if service.image %}color: white;{% endif %}">{{ service.title }}</h1>
            <p class="ls-lead" style="{% if service.image %}color: #eee;{% endif %}">{{ service.subtitle }}</p>
        </div>
    </div>

    <div class="container ls-container">
        <!-- Main Content -->
        <div class="ls-main">
            <!-- Main Overview -->
            <div class="ls-block">
                <h2>Overview</h2>
                <p>{{ service.overview }}</p>
            </div>

            <!-- Dynamic Sections (Main Column) -->
            {% for section in service.sections.all %}
            {% if section.section_type == 'text' %}
            <div class="ls-block">
                {% if section.heading %}<h2>{{ section.heading }}</h2>{% endif %}
                <p>{{ section.content }}</p>
            </div>

            {% elif section.section_type == 'process' %}
            <div class="ls-block">
                {% if section.heading %}<h2>{{ section.heading }}</h2>{% endif %}
                <div class="ls-steps">
                    {% for item in section.get_items_list %}
                    <div class="ls-step">
                        <span class="ls-step-num">{{ forloop.counter }}</span>
                        <p>{{ item }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% elif section.section_type == 'benefits' %}
            <div class="ls-block">
                {% if section.heading %}<h2>{{ section.heading }}</h2>{% endif %}
                <ul style="list-style: none; padding: 0;">
                    {% for item in section.get_items_list %}
                    <li style="margin-bottom: 10px; display: flex; gap: 10px;">
                        <span style="color: #2c5f7c; font-weight: bold;">✓</span> {{ item }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% endfor %}
            <!-- Photo Gallery Section -->
            {% if service.images.count > 0 %}
            <div class="ls-block gallery-section">
                <h2>{{ service.title }} Photos</h2>
                <div class="gallery-grid">
                    {% for img in service.images.all %}
                    <div class="gallery-item" onclick="openLightbox('{{ forloop.counter0 }}')">
                        <img src="{% static 'images/' %}{{ img.image }}" alt="{{ img.caption|default:service.title }}"
                            data-index="{{ forloop.counter0 }}">
                        <div class="gallery-overlay">
                            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                <line x1="11" y1="8" x2="11" y2="14"></line>
                                <line x1="8" y1="11" x2="14" y2="11"></line>
                            </svg>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Software Section -->
            {% if service.software.count > 0 %}
            <div class="ls-block software-section">
                <h2>{{ service.title }} Software</h2>
                <div class="software-grid">
                    {% for item in service.software.all %}
                    <div class="software-item" title="{{ item.name }}">
                        <img src="{% static 'images/' %}{{ item.logo }}" alt="{{ item.name }}">
                    </div>
                    {% endfor %}
                </div>
            </div>

            <style>
                .software-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                    gap: 30px;
                    margin-top: 25px;
                    align-items: center;
                }

                .software-item {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 15px;
                    background: #f9f9f9;
                    border-radius: 8px;
                    transition: transform 0.3s ease;
                    height: 80px;
                }

                .software-item:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
                }

                .software-item img {
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    transition: all 0.3s ease;
                }

                .software-item:hover img {
                    transform: scale(1.05);
                }
            </style>
            {% endif %}
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" class="lightbox">
            <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
            <div class="lightbox-content">
                <img id="lightbox-img" src="" alt="Gallery Image">
                <div class="lightbox-caption" id="lightbox-caption"></div>

                <a class="lightbox-prev" onclick="changeSlide(-1)">&#10094;</a>
                <a class="lightbox-next" onclick="changeSlide(1)">&#10095;</a>

                <!-- Zoom Controls -->
                <div class="lightbox-controls">
                    <button onclick="zoomImage(0.2)">+</button>
                    <button onclick="zoomImage(-0.2)">-</button>
                    <button onclick="resetZoom()">Reset</button>
                </div>
            </div>
        </div>

        <style>
            .gallery-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .gallery-item {
                position: relative;
                cursor: pointer;
                overflow: hidden;
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                aspect-ratio: 4/3;
            }

            .gallery-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.4s ease;
            }

            .gallery-item:hover img {
                transform: scale(1.05);
            }

            .gallery-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .gallery-item:hover .gallery-overlay {
                opacity: 1;
            }

            /* Lightbox Styles */
            .lightbox {
                display: none;
                /* Hidden by default */
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                background-color: rgba(0, 0, 0, 0.95);
                /* Flexbox for centering */
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }

            .lightbox-content {
                position: relative;
                margin: auto;
                padding: 0;
                width: 100%;
                height: 100%;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                overflow: hidden;
                /* Contain the image */
            }

            #lightbox-img {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 4px;
                transition: transform 0.1s ease-out;
                /* Smooth drag, faster than 0.3s */
                cursor: grab;
                user-select: none;
            }

            #lightbox-img.grabbing {
                cursor: grabbing;
                transition: none;
                /* Instant follow during drag */
            }

            .lightbox-close {
                position: absolute;
                top: 20px;
                right: 35px;
                color: #f1f1f1;
                font-size: 40px;
                font-weight: bold;
                transition: 0.3s;
                cursor: pointer;
                z-index: 2001;
            }

            .lightbox-close:hover,
            .lightbox-close:focus {
                color: #bbb;
                text-decoration: none;
                cursor: pointer;
            }

            .lightbox-prev,
            .lightbox-next {
                cursor: pointer;
                position: absolute;
                top: 50%;
                width: auto;
                padding: 16px;
                margin-top: -50px;
                color: white;
                font-weight: bold;
                font-size: 30px;
                transition: 0.6s ease;
                border-radius: 0 3px 3px 0;
                user-select: none;
                -webkit-user-select: none;
                background: rgba(0, 0, 0, 0.2);
                z-index: 2002;
            }

            .lightbox-next {
                right: 0;
                border-radius: 3px 0 0 3px;
            }

            .lightbox-prev {
                left: 0;
                border-radius: 3px 0 0 3px;
            }

            .lightbox-prev:hover,
            .lightbox-next:hover {
                background-color: rgba(0, 0, 0, 0.8);
            }

            .lightbox-controls {
                position: absolute;
                bottom: 20px;
                background: rgba(0, 0, 0, 0.5);
                padding: 10px 20px;
                border-radius: 30px;
                z-index: 2002;
            }

            .lightbox-controls button {
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.5);
                color: white;
                padding: 5px 15px;
                cursor: pointer;
                border-radius: 4px;
                margin: 0 5px;
                font-size: 1rem;
            }

            .lightbox-controls button:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: white;
            }
        </style>

        <script>
            let currentImageIndex = 0;
            let currentZoom = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX, startY;
            let images = [];

            // Initialize images array on load
            document.addEventListener("DOMContentLoaded", function () {
                const imgElements = document.querySelectorAll('.gallery-grid img');
                imgElements.forEach((img, index) => {
                    images.push({
                        src: img.src,
                        caption: img.alt
                    });
                });

                // Attach events to lightbox image
                const img = document.getElementById('lightbox-img');
                img.addEventListener('mousedown', startDrag);
                img.addEventListener('mousemove', drag);
                img.addEventListener('mouseup', endDrag);
                img.addEventListener('mouseleave', endDrag);
                img.addEventListener('wheel', handleWheel);

                // Touch support
                img.addEventListener('touchstart', touchStart);
                img.addEventListener('touchmove', touchMove);
                img.addEventListener('touchend', endDrag);
            });

            function openLightbox(index) {
                currentImageIndex = parseInt(index);
                showLightbox();
                updateLightboxImage();
                resetZoom();
            }

            function closeLightbox() {
                document.getElementById('lightbox').style.display = "none";
                resetZoom();
            }

            function showLightbox() {
                document.getElementById('lightbox').style.display = "flex";
            }

            function changeSlide(n) {
                currentImageIndex += n;
                if (currentImageIndex >= images.length) {
                    currentImageIndex = 0;
                }
                if (currentImageIndex < 0) {
                    currentImageIndex = images.length - 1;
                }
                updateLightboxImage();
                resetZoom();
            }

            function updateLightboxImage() {
                const img = document.getElementById('lightbox-img');
                img.src = images[currentImageIndex].src;
            }

            function updateTransform() {
                const img = document.getElementById('lightbox-img');
                img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
            }

            function zoomImage(delta) {
                const newZoom = currentZoom + delta;
                if (newZoom >= 0.1 && newZoom <= 10) { // Limit zoom range
                    currentZoom = newZoom;
                    updateTransform();
                }
            }

            function resetZoom() {
                currentZoom = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            }

            // Drag Functionality
            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                document.getElementById('lightbox-img').classList.add('grabbing');
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }

            function endDrag() {
                isDragging = false;
                document.getElementById('lightbox-img').classList.remove('grabbing');
            }

            // Touch handlers
            function touchStart(e) {
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - translateX;
                    startY = e.touches[0].clientY - translateY;
                }
            }
            function touchMove(e) {
                if (!isDragging) return;
                if (e.touches.length === 1) {
                    e.preventDefault(); // Prevent scrolling
                    translateX = e.touches[0].clientX - startX;
                    translateY = e.touches[0].clientY - startY;
                    updateTransform();
                }
            }

            // Wheel Zoom
            function handleWheel(e) {
                e.preventDefault();
                const delta = Math.sign(e.deltaY) * -0.2;
                zoomImage(delta);
            }

            // Close on outside click (if not dragging)
            window.onclick = function (event) {
                const modal = document.getElementById('lightbox');
                const content = document.querySelector('.lightbox-content');
                // Only close if clicking the dark overlay, not the content area
                if (event.target == modal || event.target == content) {
                    closeLightbox();
                }
            }

            // Keyboard nav
            document.addEventListener('keydown', function (event) {
                if (document.getElementById('lightbox').style.display === "flex") {
                    if (event.key === "Escape") closeLightbox();
                    if (event.key === "ArrowLeft") changeSlide(-1);
                    if (event.key === "ArrowRight") changeSlide(1);
                    if (event.key === "+" || event.key === "=") zoomImage(0.2);
                    if (event.key === "-") zoomImage(-0.2);
                    if (event.key === "0") resetZoom();
                }
            });
        </script>

        <!-- Sidebar -->
        <aside class="ls-sidebar">
            <!-- All Services Widget -->
            <div class="ls-widget ls-widget-primary">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round"
                        style="vertical-align: text-bottom; margin-right: 8px;">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>All Services
                </h3>
                <ul>
                    {% for s in services %}
                    <li>
                        <a href="{% url 'service_detail' s.id %}"
                            style="text-decoration: none; color: {% if s.id == service.id %}#2c5f7c{% else %}inherit{% endif %}; font-weight: {% if s.id == service.id %}bold{% else %}normal{% endif %}; display: flex; align-items: center;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                style="margin-right: 8px; flex-shrink: 0;">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                            {{ s.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <!-- Dynamic Sections (Sidebar) -->
            {% for section in service.sections.all %}
            {% if section.section_type == 'list' %}
            <div class="ls-widget ls-widget-primary">
                {% if section.heading %}<h3>{{ section.heading }}</h3>{% endif %}
                <ul>
                    {% for item in section.get_items_list %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            </div>

            {% elif section.section_type == 'tags' %}
            <div class="ls-widget">
                {% if section.heading %}<h3>{{ section.heading }}</h3>{% endif %}
                <div class="ls-tags">
                    {% for item in section.get_items_list %}
                    <span class="ls-tag">{{ item }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}

            <div class="ls-cta-box">
                <h4>Ready to start?</h4>
                <p style="font-size: 0.9rem; margin-bottom: 15px; color: #666;">Contact us today to discuss your
                    project.</p>
                <a href="{% url 'contact' %}" class="btn-sidebar">Get a Free Quote</a>
            </div>
        </aside>
    </div>
</section>
{% endblock %}